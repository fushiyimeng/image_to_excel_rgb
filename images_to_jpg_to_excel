import cv2
import numpy as np
import xlsxwriter
import os
from PIL import Image

def convert_images_to_jpg(input_dir=".", output_dir="image"):
    """
    å°†è¾“å…¥ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡è½¬ä¸ºJPGæ ¼å¼ï¼Œä¿å­˜åˆ°/imageç›®å½•ï¼Œå¹¶è¿”å›æ–‡ä»¶ååˆ—è¡¨
    :param input_dir: è¾“å…¥ç›®å½•ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰
    :param output_dir: è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤/imageï¼‰
    :return: è½¬æ¢åçš„å›¾ç‰‡è·¯å¾„åˆ—è¡¨ï¼ˆå¦‚ ["image/photo1.jpg", "image/photo2.jpg"]ï¼‰
    """
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(output_dir, exist_ok=True)
    
    supported_formats = [".jpg", ".jpeg", ".png", ".avif", ".webp", ".bmp"]
    converted_files = []
    
    # éå†è¾“å…¥ç›®å½•ä¸‹çš„æ–‡ä»¶
    for filename in os.listdir(input_dir):
        # æ£€æŸ¥æ˜¯å¦ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼
        ext = os.path.splitext(filename)[1].lower()
        if ext not in supported_formats:
            continue
            
        # è¯»å–å›¾ç‰‡ï¼ˆå…¼å®¹æ‰€æœ‰æ ¼å¼ï¼‰
        input_path = os.path.join(input_dir, filename)
        try:
            img = Image.open(input_path)
            if img.mode != 'RGB':
                img = img.convert('RGB')
        except Exception as e:
            print(f"âš ï¸ è·³è¿‡æŸåæ–‡ä»¶ {filename}: {e}")
            continue
            
        # è¾“å‡ºè·¯å¾„ï¼ˆä¿æŒåŸåï¼Œæ‰©å±•åæ”¹ä¸º.jpgï¼‰
        output_name = os.path.splitext(filename)[0] + ".jpg"
        output_path = os.path.join(output_dir, output_name)
        
        # ä¿å­˜ä¸ºJPG
        img.save(output_path, "JPEG", quality=95)
        converted_files.append(output_path)
        print(f"âœ… è½¬æ¢æˆåŠŸ: {filename} -> {output_path}")
    
    return converted_files


def arrange_images(image_paths, output_excel="output.xlsx", mode="horizontal", cell_size=10):
    """
    å°†å¤šå¼ å›¾ç‰‡æ’åˆ—åˆ°Excelä¸­ï¼ˆæ¨ªå‘/çºµå‘ï¼‰
    :param image_paths: å›¾ç‰‡è·¯å¾„åˆ—è¡¨
    :param output_excel: è¾“å‡ºExcelæ–‡ä»¶å
    :param mode: æ’åˆ—æ¨¡å¼ ("horizontal"|"vertical")
    :param cell_size: å•å…ƒæ ¼å¤§å°
    """
    workbook = xlsxwriter.Workbook(output_excel)
    worksheet = workbook.add_worksheet()
    
    print("æ­£åœ¨å¼€å§‹è®¡ç®—å¤§å°å’Œç»˜ç”»ï¼Œè¯·ç¨ç­‰...")
    # è®¡ç®—æ€»ç”»å¸ƒå°ºå¯¸
    if mode == "horizontal":
        total_width = sum(cv2.imread(img).shape[1] for img in image_paths)
        max_height = max(cv2.imread(img).shape[0] for img in image_paths)
    else:  # vertical
        total_width = max(cv2.imread(img).shape[1] for img in image_paths)
        max_height = sum(cv2.imread(img).shape[0] for img in image_paths)
    
    # è®¾ç½®å•å…ƒæ ¼ä¸ºæ­£æ–¹å½¢
    for i in range(max_height):
        worksheet.set_row(i, cell_size)
    for j in range(total_width):
        worksheet.set_column(j, j, cell_size / 7)
    
    # å¡«å……å›¾ç‰‡
    x_offset, y_offset = 0, 0
    for img_path in image_paths:
        img = cv2.imread(img_path)
        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        height, width = img.shape[:2]
        
        for i in range(height):
            for j in range(width):
                r, g, b = img[i, j]
                cell_format = workbook.add_format({'bg_color': f'#{r:02x}{g:02x}{b:02x}'})
                if mode == "horizontal":
                    worksheet.write_blank(i, x_offset + j, '', cell_format)
                else:
                    worksheet.write_blank(y_offset + i, j, '', cell_format)
        
        # æ›´æ–°åç§»é‡
        if mode == "horizontal":
            x_offset += width
        else:
            y_offset += height
    
    workbook.close()
    print(f"ğŸ¨ Excelç”Ÿæˆå®Œæˆ: {output_excel}")

image_paths = convert_images_to_jpg()

arrange_images(image_paths, output_excel="output.xlsx", mode="horizontal", cell_size=10)
